<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TechCrush v28 (Phones in History)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { bg: '#020617', card: '#0f172a' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: white; padding: 16px; min-height: 100vh; }
        .input-box { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; font-size: 14px; }
        .input-box:focus { border-color: #22c55e; background: #0f172a; outline: none; }
        .paste-zone { background: #0f172a; border: 1px dashed #475569; color: #94a3b8; font-size: 12px; font-family: monospace; padding: 10px; width: 100%; resize: none; border-radius: 8px; }

        .btn-main { background: linear-gradient(to right, #15803d, #22c55e); color: white; font-weight: bold; font-size: 14px; border-radius: 10px; padding: 14px; width: 100%; text-align: center; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); transition: transform 0.1s; }
        .btn-main:active { transform: scale(0.98); }
        .btn-wa { background: #064e3b; border: 1px solid #065f46; padding: 14px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; text-decoration: none; transition: background 0.2s; }
        .btn-wa:hover { background: #065f46; }
        .btn-wa.done { border-color: #4ade80; opacity: 0.6; }

        .btn-pay { background: linear-gradient(to right, #16a34a, #15803d); color: white; font-weight: bold; padding: 12px; border-radius: 10px; width: 100%; text-align: center; display: block; margin-top: 10px; box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3); pointer-events: auto; }
        
        .chip { background: #1e293b; border: 1px solid #334155; color: #cbd5e1; font-size: 11px; padding: 8px 14px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .chip:hover { border-color: #fbbf24; color: white; }
        .chip.active { background: #fbbf24; color: black; font-weight: bold; border-color: #fbbf24; }

        .hidden { display: none !important; }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #0f172a; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: bold; color: #64748b; border-radius: 8px; transition: all 0.2s; }
        .tab-btn.active { background: #1e293b; color: white; border: 1px solid #334155; }

        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-input { background: transparent; border: none; border-bottom: 2px solid #475569; color: white; font-size: 24px; letter-spacing: 10px; text-align: center; width: 150px; outline: none; }
        #errorLog { display: none; color: red; font-size: 10px; margin-top: 10px; }
    </style>
</head>
<body class="max-w-md mx-auto" onmousemove="resetIdle()" onclick="resetIdle()" onkeypress="resetIdle()">

    <div id="lockScreen">
        <div class="mb-6 text-center">
            <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-2xl">üîí</span></div>
            <h2 class="text-xl font-bold text-white">TechCrush Admin</h2>
            <p class="text-xs text-gray-500 mt-1">System Locked</p>
        </div>
        <input type="password" id="pinEntry" class="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="checkPin()">
        <p id="errorLog">Invalid PIN</p>
    </div>

    <div id="appContent" class="hidden">

        <div class="flex justify-between items-center mb-4">
            <h1 class="text-lg font-bold text-white">TechCrush OS <span class="text-[10px] text-green-500">WA-v28</span></h1>
            <div class="text-[10px] bg-slate-800 px-2 py-1 rounded text-gray-400 font-mono" id="timeDisplay">--:--</div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('dispatch', event)">üöÄ WhatsApp Dispatch</button>
            <button class="tab-btn" onclick="switchTab('verify', event)">üí∞ Verify & Pay</button>
        </div>

        <div id="dispatchTab">
            <div class="bg-red-900/20 border border-red-800/50 p-3 rounded-xl mb-4 flex justify-between items-center">
                <div><span class="text-[10px] text-red-400 font-bold uppercase block">Current Match Code (4-Digit)</span></div>
                <div class="flex items-center gap-2">
                    <input type="text" id="securityCode" class="bg-red-900/40 text-red-300 font-mono text-xl font-bold w-16 text-center rounded border border-red-700/50 p-1" readonly>
                    <button onclick="generateNewSecurityCode()" class="text-xs bg-slate-800 p-2 rounded">üîÑ</button>
                </div>
            </div>

            <div class="bg-card p-4 rounded-xl border border-slate-800 mb-4 shadow-lg">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] text-blue-400 font-bold uppercase">Room Data</label>
                    <div class="flex items-center gap-2">
                        <button onclick="clearDispatchInput()" class="text-[10px] text-red-400 underline mr-2">Clear</button>
                        <input type="checkbox" id="manualMode" onchange="toggleMode()" class="w-4 h-4 accent-green-500 rounded"><label class="text-[10px] text-gray-400 uppercase font-bold">Manual</label>
                    </div>
                </div>
                <div id="autoSection"><textarea id="ludoRaw" rows="2" placeholder='Paste Ludo Text...' class="paste-zone" oninput="extractGameInfo()"></textarea></div>
                <div id="manualSection" class="hidden grid grid-cols-2 gap-3"><input type="text" id="manualID" placeholder="ID" class="input-box text-center" oninput="syncManual()"><input type="text" id="manualLink" placeholder="Link" class="input-box" oninput="syncManual()"></div>
            </div>

            <div class="bg-card p-4 rounded-xl border border-slate-800 mb-6">
                <div class="flex justify-between mb-3"><label class="text-[10px] text-green-400 font-bold uppercase">Phone Numbers</label><button onclick="extractPhoneNumbers()" class="text-[10px] bg-slate-700 px-2 py-1 rounded">Find Numbers</button></div>
                <textarea id="playerRaw" rows="2" placeholder='Paste text with numbers...' class="paste-zone mb-4"></textarea>
                <div class="space-y-3">
                    <input type="tel" id="p1" placeholder="Phone 1" class="input-box" />
                    <input type="tel" id="p2" placeholder="Phone 2" class="input-box" />
                    <input type="tel" id="p3" placeholder="Phone 3" class="input-box" />
                    <input type="tel" id="p4" placeholder="Phone 4" class="input-box" />
                    <input type="tel" id="p5" placeholder="Phone 5" class="input-box" />
                </div>
            </div>
            <button onclick="preparePreview()" class="btn-main mb-8">LAUNCH ON WHATSAPP</button>
        </div>

        <div id="verifyTab" class="hidden">
            <div class="bg-card p-4 rounded-xl border border-slate-800 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase">3-Step Verification</h3>
                    <button onclick="resetVerify()" class="text-[10px] text-red-400 underline">Reset Form</button>
                </div>

                <textarea id="claimRaw" rows="2" placeholder="Paste full message here to auto-fill..." class="paste-zone mb-4" oninput="autoFillVerify()"></textarea>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[9px] text-gray-500 uppercase block mb-1">1. Room ID</label><input type="text" id="v_roomID" class="input-box text-center font-bold text-yellow-400"></div>
                    <div><label class="text-[9px] text-gray-500 uppercase block mb-1">2. Secret Code (4-Digit)</label><input type="text" id="v_code" placeholder="Ex: 4592" class="input-box text-center font-bold text-red-400 uppercase"></div>
                </div>

                <div class="mb-4"><label class="text-[9px] text-gray-500 uppercase block mb-1">3. Winner UPI ID</label><input type="text" id="v_upi" class="input-box"></div>

                <button onclick="verifyAndCheck()" class="w-full bg-slate-700 hover:bg-slate-600 text-xs py-3 rounded mb-4 font-bold border border-slate-600">üîç VERIFY MATCH DATA</button>

                <div id="verifyResult" class="hidden border-t border-slate-700 pt-4">
                    <div id="statusBox" class="p-3 rounded-lg text-center mb-4 bg-slate-800 border border-slate-700">
                        <span id="matchStatusText" class="text-sm font-bold text-gray-400">Checking...</span>
                    </div>

                    <div id="paymentSection" class="hidden">
                        <div class="flex gap-2 justify-center mb-4">
                            <span onclick="setPrize(300, event)" class="chip active">‚Çπ300</span>
                            <span onclick="setPrize(600, event)" class="chip">‚Çπ600</span>
                            <span onclick="setPrize(1500, event)" class="chip">‚Çπ1500</span>
                        </div>
                        <div class="flex justify-between items-center mb-2 bg-slate-800 p-2 rounded-lg border border-slate-700">
                            <span class="text-xs text-gray-400 font-bold ml-1">Prize (‚Çπ):</span>
                            <input type="number" id="prizeAmount" value="300" class="bg-transparent text-white font-bold w-24 text-right outline-none text-lg" oninput="manualPrizeUpdate()">
                        </div>
                        <a id="payLink" href="#" target="_blank" class="btn-pay">üí∏ PAY NOW</a>
                    </div>
                </div>
            </div>

            <div class="bg-card rounded-xl border border-slate-800 p-4">
                <div class="flex justify-between items-center mb-3">
                    <div><h3 class="text-xs font-bold text-gray-400 uppercase">History</h3><span id="totalPaidDisplay" class="text-[10px] text-green-400 font-mono">Total Paid: ‚Çπ0</span></div>
                    <div class="flex gap-2">
                        <button onclick="downloadBackup()" class="text-[10px] text-blue-400 border border-blue-900 px-2 py-1 rounded hover:bg-blue-900/30">‚¨á Backup</button>
                        <button onclick="toggleRestore()" class="text-[10px] text-yellow-400 border border-yellow-900 px-2 py-1 rounded hover:bg-yellow-900/30">‚¨Ü Restore</button>
                        <button onclick="clearHistory()" class="text-[10px] text-red-500 border border-red-900 px-2 py-1 rounded hover:bg-red-900/30">Clear</button>
                    </div>
                </div>

                <div id="restoreArea" class="hidden mb-2">
                    <textarea id="restoreInput" rows="2" class="paste-zone mb-1" placeholder="Paste your backup JSON here..."></textarea>
                    <button onclick="processRestore()" class="w-full bg-yellow-700/50 text-xs py-1 rounded text-yellow-200">Confirm Restore</button>
                </div>

                <div class="flex justify-between px-2 text-[9px] text-gray-500 uppercase mb-2 border-b border-slate-800 pb-1">
                    <span class="w-10">Time</span><span class="w-16">ID/Phone</span><span class="w-12 text-center text-green-600">Amt</span><span class="w-8 text-center">Code</span><span class="w-8 text-right">Sts</span>
                </div>
                <div id="historyList" class="history-container overflow-y-auto max-h-60"></div>
            </div>
        </div>

        <div id="previewModal" class="hidden fixed inset-0 bg-black/95 z-[60] flex items-center justify-center p-4">
            <div class="bg-card border border-slate-700 w-full max-w-sm rounded-xl p-4 shadow-2xl">
                <h3 class="text-sm font-bold text-white mb-2">‚úèÔ∏è Edit SMS Message</h3>
                <textarea id="previewText" rows="8" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm text-gray-200 focus:border-green-500 focus:outline-none mb-4"></textarea>
                <div class="flex gap-2">
                    <button onclick="closePreview()" class="flex-1 bg-slate-800 text-gray-400 text-xs py-3 rounded">Cancel</button>
                    <button onclick="confirmAndSend()" class="flex-1 bg-green-600 text-white font-bold text-xs py-3 rounded">CONFIRM & SEND</button>
                </div>
            </div>
        </div>

        <div id="dispatchView" class="hidden fixed inset-0 bg-black z-50 p-6 pt-20 overflow-y-auto">
            <h2 class="text-center text-xl font-bold text-white mb-2">Sending Info</h2>
            <div class="text-center mb-6"><span class="text-lg font-bold text-red-400 font-mono" id="securityCodeDisplay">--</span></div>
            <div id="buttonsContainer"></div>
            <button onclick="closeDispatch()" class="w-full mt-8 text-sm text-gray-500 underline py-4">‚Üê Close & New Match</button>
        </div>
    </div>

    <input type="hidden" id="finalCode"><input type="hidden" id="finalLink">

    <script>
        // HISTORY & LOCK LOGIC
        function safeGetHistory() { try { const d=localStorage.getItem('tc_history_v2'); return d?JSON.parse(d):[]; } catch(e){ return []; } }
        
        // PIN: 2025
        const ENCODED_PIN = "MjAyNQ=="; 
        let idleTime = 0;

        function checkPin() { 
            const input = document.getElementById('pinEntry').value;
            if(input === atob(ENCODED_PIN)){
                document.getElementById('lockScreen').style.display='none';
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('pinEntry').value = ""; 
                initApp();
            } else if (input.length >= 4) {
                 document.getElementById('pinEntry').value = "";
                 document.getElementById('errorLog').style.display = 'block';
            }
        }

        setInterval(function() { idleTime++; if (idleTime > 5) { document.getElementById('appContent').classList.add('hidden'); document.getElementById('lockScreen').style.display = 'flex'; } }, 60000); 
        function resetIdle() { idleTime = 0; }
        function initApp() { generateNewSecurityCode(); setInterval(updateClock, 1000); updateClock(); loadHistory(); }
        function updateClock() { document.getElementById('timeDisplay').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

        function switchTab(tab, event) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('dispatchTab').classList.add('hidden'); document.getElementById('verifyTab').classList.add('hidden');
            if(tab === 'dispatch') { document.getElementById('dispatchTab').classList.remove('hidden'); if(event) event.target.classList.add('active'); } 
            else { document.getElementById('verifyTab').classList.remove('hidden'); if(event) event.target.classList.add('active'); loadHistory(); }
        }

        // --- DISPATCHER ---
        // CHANGED: 4-Digit Number Generator
        function generateNewSecurityCode() { 
            // Generates number between 1000 and 9999
            const code = Math.floor(1000 + Math.random() * 9000);
            document.getElementById('securityCode').value = code; 
        }

        function toggleMode() { const man=document.getElementById('manualMode').checked; document.getElementById('autoSection').classList.toggle('hidden', man); document.getElementById('manualSection').classList.toggle('hidden', !man); }
        function clearDispatchInput() { document.getElementById('ludoRaw').value=""; document.getElementById('manualID').value=""; document.getElementById('manualLink').value=""; document.getElementById('finalCode').value=""; document.getElementById('finalLink').value=""; }

        function extractGameInfo() {
            try {
                const t=document.getElementById('ludoRaw').value; 
                if(!t) return;
                const c=t.match(/Room Code:\s*(\d+)/); 
                const l=t.match(/(https:\/\/lk\.gggred\.com[^\s]+)/);
                if(c && c[1]){document.getElementById('finalCode').value=c[1];document.getElementById('manualID').value=c[1];}
                if(l && l[1]){document.getElementById('finalLink').value=l[1];document.getElementById('manualLink').value=l[1];}else{document.getElementById('finalLink').value="https://www.techcrush.in";}
            } catch(e) { console.log("Extraction Error"); }
        }
        function syncManual() { document.getElementById('finalCode').value=document.getElementById('manualID').value; document.getElementById('finalLink').value=document.getElementById('manualLink').value; }

        function extractPhoneNumbers() { 
            try {
                const raw = document.getElementById('playerRaw').value;
                if(!raw) return;
                const m = raw.match(/\d{10}/g); 
                for(let i=1;i<=5;i++) document.getElementById('p'+i).value=""; 
                if(m) m.forEach((u,i)=>{ if(i<5) document.getElementById('p'+(i+1)).value=u; }); 
                document.getElementById('playerRaw').value=""; 
            } catch(e) { console.log("Phone Error"); }
        }

        // PREVIEW FUNCTION
        function preparePreview() {
            const code = document.getElementById('finalCode').value; 
            const sec = document.getElementById('securityCode').value; 
            const players = [1,2,3,4,5].map(i=>document.getElementById('p'+i).value.trim()).filter(p=>p!=="");

            if(!code || players.length===0){alert("Missing Data");return;}

            const link = document.getElementById('finalLink').value||"https://www.techcrush.in";
            
            // Raw text for editing
            const rawMsg = `üéÆ *MATCH STARTED!* \n\nüîë ID: *${code}* \nüîó Link: ${link} \n\nüõë *IMPORTANT:* Win hone par Ludo Chat me *${sec}* likhna JARURI hai.`;
            
            document.getElementById('previewText').value = rawMsg;
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
        }

        // CONFIRM AND GENERATE
        function confirmAndSend() {
            closePreview();
            
            // Get edited text and Encode it
            const rawText = document.getElementById('previewText').value;
            const finalMsg = encodeURIComponent(rawText);

            const code = document.getElementById('finalCode').value; 
            const sec = document.getElementById('securityCode').value; 
            const players = [1,2,3,4,5].map(i=>document.getElementById('p'+i).value.trim()).filter(p=>p!=="");

            // Save History (Unpaid) - NOW INCLUDES PLAYER PHONES
            saveToHistory(code, sec, 0, players); 
            document.getElementById('securityCodeDisplay').innerText = sec;

            const con = document.getElementById('buttonsContainer'); 
            con.innerHTML = "";
            
            players.forEach((u,i)=>{
                let cleanNum = u.replace(/\D/g,'');
                if(cleanNum.length === 10) cleanNum = "91" + cleanNum;

                const a = document.createElement('a'); 
                a.className = "btn-wa"; 
                a.innerHTML = `<div class="flex items-center gap-3">
                                <span class="text-xs text-green-400">P${i+1}</span>
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-white">+${cleanNum}</span>
                                    <span class="text-[10px] text-gray-400">Code: ${sec}</span>
                                </div>
                               </div>
                               <span class="text-xs bg-green-600 text-white px-3 py-1 rounded">WHATSAPP ‚ûú</span>`;
                
                a.href = `https://wa.me/${cleanNum}?text=${finalMsg}`; 
                a.target = "_blank";
                a.onclick = function(){ this.className+=" done"; this.querySelector('span:last-child').innerText="‚úÖ"; };
                con.appendChild(a);
            });

            document.getElementById('dispatchView').classList.remove('hidden');
            clearDispatchInput(); 
            document.getElementById('playerRaw').value = ""; 
            for(let i=1; i<=5; i++) document.getElementById('p'+i).value = "";
        }

        function closeDispatch() { document.getElementById('dispatchView').classList.add('hidden'); generateNewSecurityCode(); loadHistory(); }

        // --- VERIFY & PAY ---
        function autoFillVerify() {
            try {
                const t=document.getElementById('claimRaw').value; if(!t)return;
                const id=t.match(/(\d{6,8})/); 
                // CHANGED: Regex to find 4 digit code (looking for exactly 4 digits not inside a larger number)
                const cd=t.match(/\b\d{4}\b/); 
                const up=t.match(/[a-zA-Z0-9.\-_]+@[a-zA-Z]+/);
                
                if(id)document.getElementById('v_roomID').value=id[0];
                if(cd)document.getElementById('v_code').value=cd[0];
                if(up)document.getElementById('v_upi').value=up[0];
            } catch(e){ console.log("Autofill error"); }
        }

        function verifyAndCheck() {
            const rid = document.getElementById('v_roomID').value;
            const sec = document.getElementById('v_code').value;
            const resBox = document.getElementById('verifyResult');
            const stsBox = document.getElementById('statusBox');
            const stsTxt = document.getElementById('matchStatusText');
            const paySec = document.getElementById('paymentSection');

            resBox.classList.remove('hidden');
            const hist = safeGetHistory();
            const match = hist.find(h => h.id == rid);

            if (!match) {
                stsBox.className = "p-3 rounded-lg text-center mb-4 bg-red-900/20 border border-red-700";
                stsTxt.innerText = "‚ùå Match ID Not Found";
                stsTxt.className = "text-sm font-bold text-red-500";
                paySec.classList.add('hidden');
                return;
            }

            // Loose comparison (string vs number) is fine here
            if (match.code != sec) {
                stsBox.className = "p-3 rounded-lg text-center mb-4 bg-red-900/20 border border-red-700";
                stsTxt.innerHTML = `‚ö†Ô∏è WRONG SECURITY CODE <br><span class='text-[10px]'>Correct: ${match.code}</span>`;
                stsTxt.className = "text-sm font-bold text-red-500";
                paySec.classList.add('hidden');
                return;
            }

            if (match.status === 'PAID') {
                stsBox.className = "p-3 rounded-lg text-center mb-4 bg-blue-900/20 border border-blue-700";
                stsTxt.innerHTML = `‚ö†Ô∏è ALREADY PAID <br><span class='text-[10px]'>Paid: ‚Çπ${match.paid}</span>`;
                stsTxt.className = "text-sm font-bold text-blue-400";
                paySec.classList.add('hidden');
                return;
            }

            stsBox.className = "p-3 rounded-lg text-center mb-4 bg-green-900/20 border border-green-700";
            stsTxt.innerText = "‚úÖ MATCH VERIFIED - PAY NOW";
            stsTxt.className = "text-sm font-bold text-green-500";
            paySec.classList.remove('hidden');
            document.getElementById('prizeAmount').value = 300; 
            updatePayLink();
        }

        function setPrize(amt,e) { 
            document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); e.target.classList.add('active');
            document.getElementById('prizeAmount').value=amt; updatePayLink();
        }
        function manualPrizeUpdate(){ updatePayLink(); }

        function updatePayLink() {
            const amt = document.getElementById('prizeAmount').value;
            const upi = document.getElementById('v_upi').value;
            const btn = document.getElementById('payLink');
            if(!upi) { btn.href="#"; return; }
            btn.href = `upi://pay?pa=${upi}&pn=TechCrushUser&am=${amt}&cu=INR`;
            btn.onclick = function() { markAsPaid(amt); };
        }

        function markAsPaid(amt) {
            const rid = document.getElementById('v_roomID').value;
            const hist = safeGetHistory();
            const idx = hist.findIndex(h => h.id == rid);
            if(idx > -1) {
                hist[idx].status = 'PAID';
                hist[idx].paid = parseInt(amt);
                localStorage.setItem('tc_history_v2', JSON.stringify(hist));
                loadHistory();
                document.getElementById('verifyResult').classList.add('hidden');
                resetVerify();
            }
        }

        function resetVerify() {
            document.getElementById('v_roomID').value=""; document.getElementById('v_code').value=""; document.getElementById('v_upi').value="";
            document.getElementById('claimRaw').value=""; document.getElementById('verifyResult').classList.add('hidden');
        }

        // --- HISTORY & BACKUP ---
        // CHANGED: Now accepts 'phones' array
        function saveToHistory(id, code, paid, phones) {
            const hist = safeGetHistory();
            hist.unshift({ 
                time: new Date().getTime(), 
                id: id, 
                code: code, 
                status: paid>0?'PAID':'PENDING', 
                paid: paid,
                phones: phones || [] // Save phone numbers
            });
            if(hist.length > 50) hist.pop();
            localStorage.setItem('tc_history_v2', JSON.stringify(hist));
            loadHistory();
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            const hist = safeGetHistory();
            list.innerHTML = "";
            let total = 0;

            hist.forEach(h => {
                if(h.status === 'PAID') total += (h.paid || 0);
                const d = new Date(h.time);
                const timeStr = d.getHours() + ":" + String(d.getMinutes()).padStart(2,'0');
                
                // Format phones for display (comma separated)
                const phoneStr = (h.phones && h.phones.length > 0) ? h.phones.join(', ') : '';

                const row = document.createElement('div');
                row.className = "flex justify-between px-2 py-2 border-b border-slate-800 items-center text-xs hover:bg-slate-800";
                
                // CHANGED: Added phone number display below the ID
                row.innerHTML = `
                    <span class="w-10 text-gray-500 font-mono">${timeStr}</span>
                    <div class="w-16 flex flex-col">
                        <span class="font-bold text-white">${h.id}</span>
                        <span class="text-[9px] text-gray-500 truncate">${phoneStr}</span>
                    </div>
                    <span class="w-12 text-center text-green-400 font-mono">${h.paid > 0 ? '‚Çπ'+h.paid : '-'}</span>
                    <span class="w-8 text-center text-fuchsia-400 font-mono">${h.code}</span>
                    <span class="w-8 text-right font-bold ${h.status==='PAID'?'text-green-500':'text-yellow-500'}">${h.status==='PAID'?'‚úî':'‚è≥'}</span>
                `;
                list.appendChild(row);
            });
            document.getElementById('totalPaidDisplay').innerText = "Total Paid: ‚Çπ" + total;
        }

        function clearHistory() { if(confirm("Clear All History?")) { localStorage.setItem('tc_history_v2', "[]"); loadHistory(); } }

        // BACKUP LOGIC (No changes needed, will automatically include new phone data)
        function downloadBackup() {
            const data = localStorage.getItem('tc_history_v2') || "[]";
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `TechCrush_Backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function toggleRestore() {
            document.getElementById('restoreArea').classList.toggle('hidden');
        }

        function processRestore() {
            const raw = document.getElementById('restoreInput').value;
            if(!raw) { alert("Please paste data first"); return; }
            try {
                const parsed = JSON.parse(raw);
                if(Array.isArray(parsed)) {
                    localStorage.setItem('tc_history_v2', JSON.stringify(parsed));
                    loadHistory();
                    document.getElementById('restoreInput').value = "";
                    document.getElementById('restoreArea').classList.add('hidden');
                    alert("History Restored Successfully!");
                } else {
                    alert("Invalid data format");
                }
            } catch(e) {
                alert("Error: Invalid JSON");
            }
        }
    </script>
</body>
</html>
